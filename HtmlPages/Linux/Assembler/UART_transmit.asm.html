<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>UART_transmit.asm</title>
</head>
<!-- Highlighting: "Asm6502" -->
<body>
<pre style='color:#8e44ad;background-color:#232629;'>
<span style='color:#7a7c7d;'>;name:            UART_transmit.asm</span>
<span style='color:#7a7c7d;'>;assemble:        avra UART_transmit.asm</span>
<span style='color:#7a7c7d;'>;flash:           avrdude -c arduino -p m328p -P /dev/ttyACM0 -b 115200 -U flash:w:UART_transmit.hex</span>
<span style='color:#7a7c7d;'>;description:     writes to the UART</span>
<span style='color:#7a7c7d;'>;                 the data can be viewed with Arduino serial monitor and serial plotter.</span>
<span style='color:#7a7c7d;'>;                 Another nice tool can be found here: https://github.com/mich-w/QtSerialMonitor</span>
<span style='color:#7a7c7d;'>;                 This tool you can keep running and connect and disconnect whenever you want.</span>
<span style='color:#7a7c7d;'>;                 One draw back is that we need to send an extra 0x0a to the UART otherwise it</span>
<span style='color:#7a7c7d;'>;                 doesn't show anything. (For the serial plotter we need to do this anyway).</span>
<span style='color:#7a7c7d;'>;inspir(at)ed from: http://www.rjhcoding.com/avr-asm-uart.php</span>
<span style='color:#7a7c7d;'>;nov 5, 2021 - agguro - no-license license</span>

<span style='color:#2980b9;'>.</span><span style='color:#2980b9;'>device</span><span style='color:#cfcfc2;'> ATmega328P</span>
<span style='color:#2980b9;'>.</span><span style='color:#2980b9;'>cseg</span>
<span style='color:#2980b9;'>.org</span><span style='color:#cfcfc2;'> </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x00</span>

<span style='color:#2980b9;'>.</span><span style='color:#2980b9;'>equ</span><span style='color:#cfcfc2;'>    baud </span><span style='color:#3f8058;'>=</span><span style='color:#cfcfc2;'> </span><span style='color:#f67400;'>9600</span>
<span style='color:#2980b9;'>.</span><span style='color:#2980b9;'>equ</span><span style='color:#cfcfc2;'>    bps  </span><span style='color:#3f8058;'>=</span><span style='color:#cfcfc2;'> </span><span style='color:#f67400;'>16000000</span><span style='color:#cfcfc2;'>/</span><span style='color:#f67400;'>16</span><span style='color:#cfcfc2;'>/baud</span><span style='color:#3f8058;'>-</span><span style='color:#f67400;'>1</span>

start:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>LOW(bps)                    </span><span style='color:#7a7c7d;'>;load baud prescale</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r17</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>HIGH(bps)                   </span><span style='color:#7a7c7d;'>;into r17:r16</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>call</span></b><span style='color:#cfcfc2;'>    UART_init</span>
<span style='color:#cfcfc2;'>    </span>
<span style='color:#cfcfc2;'>    </span><span style='color:#7a7c7d;'>;say hello</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r30</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>LOW(</span><span style='color:#f67400;'>2</span><span style='color:#cfcfc2;'>*message)              </span><span style='color:#7a7c7d;'>;load Z pointer with</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r31</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>HIGH(</span><span style='color:#f67400;'>2</span><span style='color:#cfcfc2;'>*message)             </span><span style='color:#7a7c7d;'>;datastring address</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>call</span></b><span style='color:#cfcfc2;'>    UART_puts</span>
<span style='color:#cfcfc2;'>    </span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x36</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>call</span></b><span style='color:#cfcfc2;'>    UART_putc                       </span><span style='color:#7a7c7d;'>;send '6'</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x37</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>call</span></b><span style='color:#cfcfc2;'>    UART_putc                       </span><span style='color:#7a7c7d;'>;send '7'</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x0a</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>call</span></b><span style='color:#cfcfc2;'>    UART_putc                       </span><span style='color:#7a7c7d;'>;send EOL</span>

<span style='color:#cfcfc2;'>    </span><span style='color:#7a7c7d;'>;transmit a datastring</span>
<span style='color:#cfcfc2;'>    </span><span style='color:#7a7c7d;'>;this is viewable is serial monitor as just the string.</span>
<span style='color:#cfcfc2;'>    </span><span style='color:#7a7c7d;'>;In the serial plotter it is showed as 4 graphs.</span>
loop:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r30</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>LOW(</span><span style='color:#f67400;'>2</span><span style='color:#cfcfc2;'>*datastring)           </span><span style='color:#7a7c7d;'>;load Z pointer with</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r31</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>HIGH(</span><span style='color:#f67400;'>2</span><span style='color:#cfcfc2;'>*datastring)          </span><span style='color:#7a7c7d;'>;datastring address</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>rcall</span></b><span style='color:#cfcfc2;'>   UART_puts                       </span><span style='color:#7a7c7d;'>;transmit string</span>

<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>rjmp</span></b><span style='color:#cfcfc2;'> loop</span>

<span style='color:#7a7c7d;'>;initialize UART with LOW(bps) in r16 and HIGH(bps) in r17.</span>
<span style='color:#7a7c7d;'>;bps = cpuFrequency/16/baud-1</span>
UART_init:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sts</span></b><span style='color:#cfcfc2;'>     </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc4</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>r16                        </span><span style='color:#7a7c7d;'>;load baud prescale</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sts</span></b><span style='color:#cfcfc2;'>     </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc5</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>r17                        </span><span style='color:#7a7c7d;'>;to UBRR0</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>(</span><span style='color:#f67400;'>1</span><span style='color:#3f8058;'>&lt;&lt;</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x03)</span><span style='color:#3f8058;'>|</span><span style='color:#cfcfc2;'>(</span><span style='color:#f67400;'>1</span><span style='color:#3f8058;'>&lt;&lt;</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x04)         </span><span style='color:#7a7c7d;'>;enable transmitter</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sts</span></b><span style='color:#cfcfc2;'>     </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc1</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>r16                        </span><span style='color:#7a7c7d;'>;and receiver</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ldi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>b00001110                  </span><span style='color:#7a7c7d;'>;set frame format to async, no parity, 8 data bits and 1 stop bit</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sts</span></b><span style='color:#cfcfc2;'>     </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc2</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>r16</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ret</span></b>

<span style='color:#7a7c7d;'>;send a byte in r16 to the UART</span>
UART_putc:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>lds</span></b><span style='color:#cfcfc2;'>     r17</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc0                        </span><span style='color:#7a7c7d;'>;load UCSR0A into r17</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sbrs</span></b><span style='color:#cfcfc2;'>    r17</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x05                        </span><span style='color:#7a7c7d;'>;wait for empty transmit buffer</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>rjmp</span></b><span style='color:#cfcfc2;'>    UART_putc                       </span><span style='color:#7a7c7d;'>;repeat loop</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sts</span></b><span style='color:#cfcfc2;'>     </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc6</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>r16                        </span><span style='color:#7a7c7d;'>;transmit character</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ret</span></b><span style='color:#cfcfc2;'>                                     </span><span style='color:#7a7c7d;'>;return from subroutine</span>

<span style='color:#7a7c7d;'>;send a zero terminated string to the UART</span>
<span style='color:#7a7c7d;'>;Program Memory address of string to transmit is in r30:r31 (ZH:ZL)</span>
UART_puts:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>lpm</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>Z</span><span style='color:#3f8058;'>+</span><span style='color:#cfcfc2;'>                          </span><span style='color:#7a7c7d;'>;load character from pmem</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>cpi</span></b><span style='color:#cfcfc2;'>     r16</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>$00</span><span style='color:#cfcfc2;'>                         </span><span style='color:#7a7c7d;'>;check if null</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>breq</span></b><span style='color:#cfcfc2;'>    UART_puts_end                   </span><span style='color:#7a7c7d;'>;branch if null</span>
UART_puts_wait:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>lds</span></b><span style='color:#cfcfc2;'>     r17</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc0                        </span><span style='color:#7a7c7d;'>;load UCSR0A into r17</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sbrs</span></b><span style='color:#cfcfc2;'>    r17</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x05                        </span><span style='color:#7a7c7d;'>;wait for empty transmit buffer</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>rjmp</span></b><span style='color:#cfcfc2;'>    UART_puts_wait                  </span><span style='color:#7a7c7d;'>;repeat loop</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>sts</span></b><span style='color:#cfcfc2;'>     </span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>xc6</span><span style='color:#3f8058;'>,</span><span style='color:#cfcfc2;'>r16                        </span><span style='color:#7a7c7d;'>;transmit character</span>
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>rjmp</span></b><span style='color:#cfcfc2;'>    UART_puts                       </span><span style='color:#7a7c7d;'>;repeat loop</span>
UART_puts_end:
<span style='color:#cfcfc2;'>    </span><b><span style='color:#cfcfc2;'>ret</span></b>

message:<span style='color:#cfcfc2;'>    </span><span style='color:#2980b9;'>.db</span><span style='color:#cfcfc2;'> </span><span style='color:#f44f4f;'>&quot;Hello world.&quot;</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x0a</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x00    </span>
datastring:<span style='color:#cfcfc2;'> </span><span style='color:#2980b9;'>.db</span><span style='color:#cfcfc2;'> </span><span style='color:#f44f4f;'>&quot;100 200 300 400 500&quot;</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x0a</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0</span><span style='color:#cfcfc2;'>x00</span>
</pre>
</body>
</html>
