;name:        5161AS-single-digit-led.S
;description: demo for the 5161AS single digit led.
;             the program lights one LED segment of the display with a 05. sec delay between the next state.
;             the only registers used is r16 and the carry flag.
;             assumed is that the led segments are connected to PORTD with the next configuration:
;             led - gate - value in r16
;             A     0       00000001
;             B     1       00000010
;             C     2       00000100
;             D     3       00001000
;             E     4       00010000
;             F     5       00100000
;             G     6       01000000
;             DP    7       10000000
;build:       make flash
;remark:      when running this program on an ATMega328P on a Arduino board, one must bare in mind that
;             PD0 is connected to RX of the Arduino board.
;
;dec 9, 2021 - agguro - no-license license

#define    DDRD  0x0a
#define    PORTD 0x0b

.section .text
.global main

main:
start:
    ldi     r16,0b11111111  ;r16 = 0xFF all ports as output
    out     DDRD,r16        ;r16 to DDRD (0x0a) controls PORTD's in/out state.
    eor     r16, r16        ;initialize gate0 from PORTD to HIGH
    inc     r16
    clc                     ;clear carry flag
loop:
    out     PORTD,r16       ;write r16 to PORTD
    rol     r16             ;rotate r16 through carry flag
    call    delay           ;wait a while
    rjmp    loop            ;continu rotating and writing
    
;Assembly code auto-generated by utility from Bret Mulvey
;Delay 7 999 996 cycles - 499ms 999us 750 ns at 16.0 MHz
;http://darcy.rsgc.on.ca/ACES/TEI4M/AVRdelay.html
delay:
    ldi     r18, 41
    ldi     r19, 150
    ldi     r20, 126
l1: 
    dec     r20
    brne    l1
    dec     r19
    brne    l1
    dec     r18
    brne    l1
    ret
.end
