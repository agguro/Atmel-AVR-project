<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>UART_transmit.asm</title>
</head>
<!-- Highlighting: "AVR Assembler" -->
<body>
<pre style='color:#cfcfc2;background-color:#232629;'>
<span style='color:#7a7c7d;'>;name:            UART_transmit.asm</span>
<span style='color:#7a7c7d;'>;assemble:        avra UART_transmit.asm</span>
<span style='color:#7a7c7d;'>;flash:           avrdude -p m328p -c stk500v1 -b 57600 -P /dev/ttyACM0 -U flash:w:UART_transmit.hex</span>
<span style='color:#7a7c7d;'>;description:     writes to the UART</span>
<span style='color:#7a7c7d;'>;                 the data can be viewed with Arduino serial monitor and serial plotter.</span>
<span style='color:#7a7c7d;'>;                 Another nice tool can be found here: https://github.com/mich-w/QtSerialMonitor</span>
<span style='color:#7a7c7d;'>;                 This tool you can keep running and connect and disconnect whenever you want.</span>
<span style='color:#7a7c7d;'>;                 One draw back is that we need to send an extra 0x0a to the UART otherwise it</span>
<span style='color:#7a7c7d;'>;                 doesn't show anything. (For the serial plotter we need to do this anyway).</span>
<span style='color:#7a7c7d;'>;inspir(at)ed from: http://www.rjhcoding.com/avr-asm-uart.php</span>
<span style='color:#7a7c7d;'>;nov 5, 2021 - agguro - no-license license</span>
    
<b>.cseg</b>
<b>.org</b> <span style='color:#f67400;'>0x00</span>

<b>.equ</b>    baud <span style='color:#3f8058;'>=</span> <span style='color:#f67400;'>9600</span>
<b>.equ</b>    bps  <span style='color:#3f8058;'>=</span> <span style='color:#f67400;'>16000000</span><span style='color:#3f8058;'>/</span><span style='color:#f67400;'>16</span><span style='color:#3f8058;'>/</span>baud<span style='color:#3f8058;'>-</span><span style='color:#f67400;'>1</span>

<span style='color:#8e44ad;'>start:</span>
    <b>ldi</b>     r16<span style='color:#3f8058;'>,</span>LOW<span style='color:#3f8058;'>(</span>bps<span style='color:#3f8058;'>)</span>                    <span style='color:#7a7c7d;'>;load baud prescale</span>
    <b>ldi</b>     r17<span style='color:#3f8058;'>,</span>HIGH<span style='color:#3f8058;'>(</span>bps<span style='color:#3f8058;'>)</span>                   <span style='color:#7a7c7d;'>;into r17:r16</span>
    <b><span style='color:#fdbc4b;'>call</span></b>    UART_init

    <span style='color:#7a7c7d;'>;say hello</span>
    <b>ldi</b>     r30<span style='color:#3f8058;'>,</span>LOW<span style='color:#3f8058;'>(</span><span style='color:#f67400;'>2</span><span style='color:#3f8058;'>*</span>message<span style='color:#3f8058;'>)</span>              <span style='color:#7a7c7d;'>;load Z pointer with</span>
    <b>ldi</b>     r31<span style='color:#3f8058;'>,</span>HIGH<span style='color:#3f8058;'>(</span><span style='color:#f67400;'>2</span><span style='color:#3f8058;'>*</span>message<span style='color:#3f8058;'>)</span>             <span style='color:#7a7c7d;'>;datastring address</span>
    
    <b>ldi</b> r16<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x36</span>
    <b><span style='color:#fdbc4b;'>call</span></b>    UART_putc
    <b>ldi</b> r16<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x37</span>
    <b><span style='color:#fdbc4b;'>call</span></b>    UART_putc
    <b>ldi</b> r16<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x0a</span>
    <b><span style='color:#fdbc4b;'>call</span></b>    UART_putc

    <span style='color:#7a7c7d;'>;transmit a datastring</span>
    <span style='color:#7a7c7d;'>;this is viewable is serial monitor as just the string.</span>
    <span style='color:#7a7c7d;'>;In the serial plotter it is showed as 4 graphs.</span>
<span style='color:#8e44ad;'>loop:</span>
    <b>ldi</b>     r30<span style='color:#3f8058;'>,</span>LOW<span style='color:#3f8058;'>(</span><span style='color:#f67400;'>2</span><span style='color:#3f8058;'>*</span>datastring<span style='color:#3f8058;'>)</span>           <span style='color:#7a7c7d;'>;load Z pointer with</span>
    <b>ldi</b>     r31<span style='color:#3f8058;'>,</span>HIGH<span style='color:#3f8058;'>(</span><span style='color:#f67400;'>2</span><span style='color:#3f8058;'>*</span>datastring<span style='color:#3f8058;'>)</span>          <span style='color:#7a7c7d;'>;datastring address</span>
    <b><span style='color:#fdbc4b;'>rcall</span></b>   UART_puts                       <span style='color:#7a7c7d;'>;transmit string</span>

    <b><span style='color:#fdbc4b;'>rjmp</span></b> loop

<span style='color:#7a7c7d;'>;initialize UART with LOW(bps) in r16 and HIGH(bps) in r17.</span>
<span style='color:#7a7c7d;'>;bps = cpuFrequency/16/baud-1</span>
<span style='color:#8e44ad;'>UART_init:</span>
    <b>sts</b>     <span style='color:#f67400;'>0xc4</span><span style='color:#3f8058;'>,</span>r16                <span style='color:#7a7c7d;'>;load baud prescale</span>
    <b>sts</b>     <span style='color:#f67400;'>0xc5</span><span style='color:#3f8058;'>,</span>r17                <span style='color:#7a7c7d;'>;to UBRR0</span>
    <b>ldi</b>     r16<span style='color:#3f8058;'>,(</span><span style='color:#f67400;'>1</span><span style='color:#3f8058;'>&lt;&lt;</span><span style='color:#f67400;'>0x03</span><span style='color:#3f8058;'>)|(</span><span style='color:#f67400;'>1</span><span style='color:#3f8058;'>&lt;&lt;</span><span style='color:#f67400;'>0x04</span><span style='color:#3f8058;'>)</span> <span style='color:#7a7c7d;'>;enable transmitter</span>
    <b>sts</b>     <span style='color:#f67400;'>0xc1</span><span style='color:#3f8058;'>,</span>r16                <span style='color:#7a7c7d;'>;and receiver</span>
    <b>ldi</b>     r16<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0b00001110</span>          <span style='color:#7a7c7d;'>;set frame format to async, no parity, 8 data bits and 1 stop bit</span>
    <b>sts</b>     <span style='color:#f67400;'>0xc2</span><span style='color:#3f8058;'>,</span>r16
    <b><span style='color:#fdbc4b;'>ret</span></b>                             <span style='color:#7a7c7d;'>;return from subroutine</span>

<span style='color:#7a7c7d;'>;send a byte in r16 to the UART</span>
<span style='color:#8e44ad;'>UART_putc:</span>
    <b>lds</b>     r17<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0xc0</span>                <span style='color:#7a7c7d;'>;load UCSR0A into r17</span>
    <b><span style='color:#fdbc4b;'>sbrs</span></b>    r17<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x05</span>                <span style='color:#7a7c7d;'>;wait for empty transmit buffer</span>
    <b><span style='color:#fdbc4b;'>rjmp</span></b>    UART_putc               <span style='color:#7a7c7d;'>;repeat loop</span>
    <b>sts</b>     <span style='color:#f67400;'>0xc6</span><span style='color:#3f8058;'>,</span>r16                <span style='color:#7a7c7d;'>;transmit character</span>
    <b><span style='color:#fdbc4b;'>ret</span></b>                             <span style='color:#7a7c7d;'>;return from subroutine</span>

<span style='color:#7a7c7d;'>;send a zero terminated string to the UART</span>
<span style='color:#7a7c7d;'>;Program Memory address of string to transmit is in r30:r31 (ZH:ZL)</span>
<span style='color:#8e44ad;'>UART_puts:</span>
    <b>lpm</b>     r16<span style='color:#3f8058;'>,</span>Z<span style='color:#3f8058;'>+</span>                  <span style='color:#7a7c7d;'>;load character from pmem</span>
    <b><span style='color:#fdbc4b;'>cpi</span></b>     r16<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>$00</span>                 <span style='color:#7a7c7d;'>;check if null</span>
    <b><span style='color:#fdbc4b;'>breq</span></b>    UART_puts_end           <span style='color:#7a7c7d;'>;branch if null</span>
<span style='color:#8e44ad;'>UART_puts_wait:</span>
    <b>lds</b>     r17<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0xc0</span>                <span style='color:#7a7c7d;'>;load UCSR0A into r17</span>
    <b><span style='color:#fdbc4b;'>sbrs</span></b>    r17<span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x05</span>                <span style='color:#7a7c7d;'>;wait for empty transmit buffer</span>
    <b><span style='color:#fdbc4b;'>rjmp</span></b>    UART_puts_wait          <span style='color:#7a7c7d;'>;repeat loop</span>
    <b>sts</b>     <span style='color:#f67400;'>0xc6</span><span style='color:#3f8058;'>,</span>r16                <span style='color:#7a7c7d;'>;transmit character</span>
    <b><span style='color:#fdbc4b;'>rjmp</span></b>    UART_puts               <span style='color:#7a7c7d;'>;repeat loop</span>
<span style='color:#8e44ad;'>UART_puts_end:</span>
    <b><span style='color:#fdbc4b;'>ret</span></b>                             <span style='color:#7a7c7d;'>;return from subroutine</span>

<span style='color:#8e44ad;'>message:</span>       <b>.db</b>     <span style='color:#f44f4f;'>&quot;Hello world.&quot;</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x0a</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x00</span>    
<span style='color:#8e44ad;'>datastring:</span>    <b>.db</b>     <span style='color:#f44f4f;'>&quot;100 200 300 400 500&quot;</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x0a</span><span style='color:#3f8058;'>,</span><span style='color:#f67400;'>0x00</span></pre>
</body>
</html>
