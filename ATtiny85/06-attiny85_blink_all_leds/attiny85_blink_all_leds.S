;name:        attiny85_blink_all_leds.S
;description: blink all the LED connected to available pins 0..4 with a 1 second interval.
;             PINB5 cannot be used because it is setup as RESET pin,
;             PINB6 and PINB7 are reserved pins by the manufacturer.
;build:       make flash

#define    DDRB         0x17
#define    PORTB        0x18
#define    PINB         0x16
#define    PINB3        0x03
#define    SREG         0x3F
#define    SPH          0x3E
#define    SPL          0x3D
#define    SRAM_START   0x0060
#define    SRAM_END     0x025F
#define    SRAM_SIZE    SRAM_END-SRAM_START+1
#define    XH           r27
#define    XL           r26
#define    YH           r29
#define    YL           r28
#define    ZH           r31
#define    ZL           r30
#define    LOW(x)       ((x) & 0xFF)
#define    HIGH(x)      (((x)>>8) & 0xFF)

.section .text
.global main

main:
    ;setup stack ; Atmel ATtiny85 Datasheet p.8 and further
    eor     r1, r1                  ;clear r1 to initialize SREG
    out     SREG, r1                ;set AVR Status Register
    ;setup stack
    ldi     YL, LOW(SRAM_END)       ;low byte of SRAM_END in YL (r28)
    ldi     YH, HIGH(SRAM_END)      ;high byte of SRAM_END in YH (r29)
    out     SPH, YH                 ;set stackpointer high byte
    out     SPL, YL                 ;set stackpointer low  byte

    ldi     r16, 0x1F               ;pin 0..4 as output
    out     DDRB, r16
    mov     r17, r16                ;keep r16 in r17 as mask to toggle bits
    ;r16 remaions unchanged meaning that all pins start LOW
    ;here you can define alternative patterns by modifying next line
    ldi    r16,0x15                 ;light leds 4,2 and 0 alternating with leds 3 and 1
loop:
    eor     r16, r17                ;all pins LOW
    out     PORTB, r16
    rcall   delay                   ;1 sec delay
    rjmp    loop
    
delay:    
    ;delay of 1 sec
    ;Assembly code auto-generated by utility from Bret Mulvey
    ;Delay 1 000 000 cycles 1s at 1.0 MHz
    ;http://darcy.rsgc.on.ca/ACES/TEI4M/AVRdelay.html

    ldi     r18, 6
    ldi     r19, 19
    ldi     r20, 174
l1: dec     r20
    brne    l1
    dec     r19
    brne    l1
    dec     r18
    brne    l1
    ret
    
.end
