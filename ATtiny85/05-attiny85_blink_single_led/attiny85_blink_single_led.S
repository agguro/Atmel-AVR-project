;name:        attiny85_blink_single_led.S
;description: blink the LED connected to PINB3 with a 1 second interval.
;             PINB5 cannot be used because it is setup as RESET pin,
;             PINB6 and PINB7 are reserved pins by the manufacturer.
;build:       make flash

#define    DDRB  0x17
#define    PORTB 0x18
#define    PINB  0x16
#define    PINB3 0x03
#define    SREG  0x3F
#define    SPH   0x3E
#define    SPL   0x3D
#define    SRAM_START   0x0060
#define    SRAM_END     0x025F
#define    SRAM_SIZE    SRAM_END-SRAM_START+1
#define    XH r27
#define    XL r26
#define    YH r29
#define    YL r28
#define    ZH r31
#define    ZL r30
#define    LOW(x)   ((x) & 0xFF)
#define    HIGH(x)   (((x)>>8) & 0xFF)

.section .text
.global main

main:
    ;setup stack ; Atmel ATtiny85 Datasheet p.8 and further
    eor     r1, r1                  ;clear r1 to initialize SREG
    out     SREG, r1                ;set AVR Status Register
    ;setup stack
    ldi     YL, LOW(SRAM_END)       ;low byte of SRAM_END in YL (r28)
    ldi     YH, HIGH(SRAM_END)      ;high byte of SRAM_END in YH (r29)
    out     SPH, YH                 ;set stackpointer high byte
    out     SPL, YL                 ;set stackpointer low  byte

    ldi     r16, 0x08               ;pin 3 as output
    out     DDRB, r16
    
loop:
    sbi     PORTB, PINB3            ;set pin 3 of PORTB HIGH
    rcall   delay                   ;5 secs delay
    cbi     PORTB, PINB3            ;set pin 3 of PORTB LOW
    rcall   delay
    rjmp    loop
    
delay:    
    ;delay of 1 sec
    ;Assembly code auto-generated by utility from Bret Mulvey
    ;Delay 1 000 000 cycles 1s at 1.0 MHz
    ;http://darcy.rsgc.on.ca/ACES/TEI4M/AVRdelay.html

    ldi     r18, 6
    ldi     r19, 19
    ldi     r20, 174
l1: dec     r20
    brne    l1
    dec     r19
    brne    l1
    dec     r18
    brne    l1
    ret
    
.end
